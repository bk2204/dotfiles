---
- name: Bootstrap a system
  hosts: all
  gather_facts: true
  environment:
    DEBIAN_FRONTEND: noninteractive
  vars:
    # Whether to bootstrap a graphical environment.  This assumes a Debian or
    # Ubuntu system.
    graphical: false
  tasks:
    - name: Check if this is a minimized Ubuntu image
      stat:
        path: /etc/dpkg/dpkg.cfg.d/excludes
        get_checksum: no
        get_mime: no
        get_attributes: no
      register: minimized_image
    - name: Install manual pages
      shell: 'yes | unminimize'
      become: true
      become_user: root
      ignore_errors: true
      when: minimized_image.stat.exists
    - name: Install git-core PPA
      apt_repository:
        repo: ppa:git-core/ppa
      become: true
      become_user: root
      when: ansible_distribution_release == 'focal'
    - name: Install neovim-stable PPA
      apt_repository:
        repo: ppa:neovim-ppa/stable
      become: true
      become_user: root
      when: ansible_distribution_release == 'focal'
    - name: Install Debian packages
      apt:
        pkg:
          - bc
          - curl
          - dc
          - git
          - gnupg
          - less
          - libpam-tmpdir
          - locales-all
          - make
          - man-db
          - manpages
          - manpages-dev
          - ncurses-term
          - neovim
          - perl
          - procps
          - python3
          - rsync
          - ruby
          - ruby-neovim
          - sshfs
          - sudo
          - tmux
          - xxd
          - zsh
        update_cache: true
      become: true
      become_user: root
      when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
    - name: Install FreeBSD packages
      package:
        name:
          - curl
          - fusefs-sshfs
          - git
          - gmake
          - gnupg
          - less
          - ncurses
          - neovim
          - perl5
          - python3
          - rsync
          - ruby
          - rubygem-neovim
          - tmux
          - xxd
          - zsh
      become: true
      become_user: root
      when: ansible_distribution == 'FreeBSD'
    - name: Install graphical packages
      apt:
        pkg:
          - alacritty
          - mate-desktop
      become: true
      become_user: root
      when: graphical
    - name: Install Firefox ESR
      apt:
        pkg:
          - firefox-esr
      become: true
      become_user: root
      # ansible_distribution_version is "n/a" on sid.  Otherwise, it contains
      # the version number.
      when: graphical and ansible_distribution == 'Debian' and ansible_distribution_version != "n/a"
    - name: Install Firefox
      apt:
        pkg:
          - firefox
      become: true
      become_user: root
      when: graphical and (ansible_distribution != 'Debian' or ansible_distribution_version == "n/a")
