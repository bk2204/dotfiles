#!/usr/bin/perl -w

use List::Util qw(shuffle);

sub expand_directories($;$)
{
	my ($dir, $recurse) = @_;

	return ($dir) unless -d $dir;

	opendir DH, $dir or die "$!";
	my @files = map { $recurse ? expand_directories($_) : $_ }
		grep { -f $_ } map { "$dir/$_" } readdir DH;
	closedir DH or die "$!";

	@files
}

my $home = $ENV{HOME};
my @files = (
	"$home/.dasher/training_english_GB.txt",
	"$home/checkouts/writings/creative",
	"$home/checkouts/writings/creative/school",
	"$home/checkouts/writings/creative/school/engl4354"
);
my @recursives = (
	"$home/checkouts/aoif"
);

@files = grep {
	!/[Mm]akefile/ &&
	!/\.(?:fo|mk|p(?:s|df))$/ &&
	!/\/\.[^\/]+/
} map {
	expand_directories($_)
} (@files, map { expand_directories($_, 1) } @recursives);

my @data;

foreach my $file (@files) {
	open(FH, $file) or die "$!";
	push @data, <FH>;
	close(FH) or die "$!";
}

my $text = join '', grep {
	!/^\./ && !/^\s*$/
} map {
	# Handle groff syntax.
	s/\\.([^\(]|\(..)//g;
	s/^\.(?:q|i|b)(\s+)/$1/g;
	s/\\\(../ /g;
	s/\\\S+//g;
	# Remove most XML tags and comments.
	s/<[^>]+>//g;
	s/<!--//g;
	s/-->//g;
	# Sometimes when XML tags are stripped, text from different tags gets stuck
	# together.  This often happens with names in DocBook.  Strip this text.
	s/[a-zA-Z]+(\.[a-zA-Z]+)+//g;
	$_
} @data;

$text =~ s/<[^>]+>//gm;
print $text;
